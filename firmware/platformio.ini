; firmware/platformio.ini
; Build any target by selecting an environment below.
; Project root (.) is used as src_dir; each env picks its file(s) via build_src_filter.

[platformio]
default_envs = wheel-esp32
src_dir = .


[env]
monitor_speed = 115200
build_unflags =
lib_ldf_mode = chain+
; Common include path for protocol.h
build_flags =
  -I include

; ===========================
; Controller MCU (ESP32 only)
; ===========================
[env:controller-esp32]
platform = espressif32
board = esp32dev
framework = arduino
build_src_filter = +<controller-mcu/main.cpp> +<include/>
lib_deps =
  knolleary/PubSubClient @ ^2.8
  bblanchon/ArduinoJson @ ^7.2.0
; WiFi / MQTT config via build flags (change for your network/broker)
; You can override these in a per-user extra config if you want.
build_flags =
  ${env.build_flags}
  -D WIFI_SSID=\"YourSSID\"
  -D WIFI_PASS=\"YourPassword\"
  -D MQTT_HOST=\"192.168.1.50\"
  -D MQTT_PORT=1883
  -D MQTT_CLIENT_ID=\"igen-controller\"
  -D CAN_TX_PIN=27
  -D CAN_RX_PIN=26
  -D CAN_BPS=500000
  -D UART_TX_PIN=17
  -D UART_RX_PIN=16

; ===========================
; Wheel slave (ESP32)
; ===========================
[env:wheel-esp32]
platform = espressif32
board = esp32dev
framework = arduino
build_src_filter = +<slave-mcus/dispense_wheel_esp.cpp> +<include/>
lib_deps =
  AccelStepper
; none beyond core
build_flags =
  ${env.build_flags}
  -D DEVICE_ID=4
  -D CAN_TX_PIN=27
  -D CAN_RX_PIN=26
  -D CAN_BPS=500000
  -D I2C_SDA=21
  -D I2C_SCL=22
  -D PIN_DIR=2
  -D PIN_STEP=5
  -D PIN_EN=-1
  -D PIN_DOCK_OK=-1       ; set to a GPIO if you add a dock sensor
  -D PIN_DOCK_ACTIVE_HIGH=1

; ===========================
; Wheel slave (UNO + MCP2515)
; ===========================
[env:wheel-uno]
platform = atmelavr
board = uno
framework = arduino
build_src_filter = +<slave-mcus/dispense_wheel_uno.cpp> +<include/>
lib_deps =
  coryjfowler/mcp_can @ ^1.5.1
build_flags =
  ${env.build_flags}
  -D DEVICE_ID=4
  -D MCP2515_CS=10
  -D MCP2515_INT=2
  -D MCP2515_CLK=16        ; set 8 if your MCP2515 module has 8 MHz crystal
  -D PIN_DIR=2
  -D PIN_STEP=5
  -D PIN_EN=-1
  -D PIN_DOCK_OK=8         ; example: digital input for IR/weight gate
  -D PIN_DOCK_ACTIVE_HIGH=1

; ===========================
; Gantry slave (ESP32) - placeholder
; ===========================
[env:gantry-esp32]
platform = espressif32
board = esp32dev
framework = arduino
build_src_filter = +<slave-mcus/gantry_esp.cpp> +<include/>
build_flags =
  ${env.build_flags}
  -D DEVICE_ID=7
  -D CAN_TX_PIN=27
  -D CAN_RX_PIN=26
  -D CAN_BPS=500000
  -D I2C_SDA=21
  -D I2C_SCL=22

; ===========================
; Gantry slave (UNO + MCP2515) - placeholder
; ===========================
[env:gantry-uno]
platform = atmelavr
board = uno
framework = arduino
build_src_filter = +<slave-mcus/gantry_uno.cpp> +<include/>
lib_deps =
  coryjfowler/mcp_can @ ^1.5.1
build_flags =
  ${env.build_flags}
  -D DEVICE_ID=7
  -D MCP2515_CS=10
  -D MCP2515_INT=2
  -D MCP2515_CLK=16
